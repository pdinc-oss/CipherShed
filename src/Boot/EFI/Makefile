include 	Makefile.inc

CFLAGS += -I.

OBJS_CTR        = cs_controller.o cs_crypto.o cs_debug.o cs_common.o cs_options.o cs_ui.o cs_service.o cs_secure_boot.o
OBJS_DRV        = cs_driver.o     cs_crypto.o cs_debug.o cs_common.o
OBJS_COMMON	= $(patsubst %.o,../../Common/%.o,Crc.o Xts.o GfMul.o Pkcs5.o Endian.o)
OBJS_CRYPTO	= $(patsubst %.o,../../Crypto/%.o,Aescrypt.o Aeskey.o Aestab.o Twofish.o Serpent.o Rmd160.o)

TARGET          = CSController.efi CSDriver.efi

%.o:	%.c %.h

all: crypt $(TARGET)

PHONY: all clean stick crypt

CSController.so: $(OBJS_CTR) $(OBJS_COMMON) $(OBJS_CRYPTO)
	ld $(LDFLAGS) $(OBJS_CTR) $(OBJS_COMMON) $(OBJS_CRYPTO) -o $@ -lgnuefi

CSDriver.so: $(OBJS_DRV) $(OBJS_COMMON) $(OBJS_CRYPTO)
	ld $(LDFLAGS) $(OBJS_DRV) $(OBJS_COMMON) $(OBJS_CRYPTO) -o $@ -lgnuefi

CSController.efi: CSController.so
	@echo [OBJ] $@
	objcopy -j .text -j .sdata -j .data -j .dynamic \
	        -j .dynsym  -j .rel -j .rela -j .reloc \
	        --target=efi-app-$(ARCH) $< $@
	@if [ "$(ARCH)" = "x86_64" ]; then \
		mv CSController.efi CsCtr_64.efi; \
	else \
		mv CSController.efi CsCtr_32.efi; \
	fi

CSDriver.efi: CSDriver.so
	@echo [OBJ] $@
	objcopy -j .text -j .sdata -j .data -j .dynamic \
	        -j .dynsym  -j .rel -j .rela -j .reloc \
	        --target=efi-bsdrv-$(ARCH) $< $@
	@if [ "$(ARCH)" = "x86_64" ]; then \
		mv CSDriver.efi CsDrv_64.efi; \
	else \
		mv CSDriver.efi CsDrv_32.efi; \
	fi

crypt:
	$(MAKE) -C ../../Crypto -f Makefile.efi 
	$(MAKE) -C ../../Common -f Makefile.efi

clean:
	rm -f *.efi *.so *.o *~
	$(MAKE) -C ../../Crypto -f Makefile.efi clean
	$(MAKE) -C ../../Common -f Makefile.efi clean

stick:	all
	if test -d /media/fn/0B3C-4FE5; then \
		cp CsDrv_64.efi CsCtr_64.efi /media/fn/0B3C-4FE5/copy/; \
		cp CsCtr_64.efi /media/fn/0B3C-4FE5/EFI/BOOT/BOOTX64.EFI; \
		cp CsDrv_64.efi /media/fn/0B3C-4FE5/EFI/BOOT/; \
		fi; sync
